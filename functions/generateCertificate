import { createClientFromRequest } from 'npm:@base44/sdk@0.7.1';
import { jsPDF } from 'npm:jspdf@2.5.1';

Deno.serve(async (req) => {
  try {
    const base44 = createClientFromRequest(req);
    const user = await base44.auth.me();
    
    if (!user) {
      return Response.json({ error: 'Unauthorized' }, { status: 401 });
    }

    const { course_id, enrollment_id } = await req.json();

    if (!course_id || !enrollment_id) {
      return Response.json({ error: 'Missing required fields' }, { status: 400 });
    }

    // Get course and enrollment data
    const course = await base44.entities.Course.get(course_id);
    const enrollment = await base44.entities.Enrollment.get(enrollment_id);

    if (!enrollment || enrollment.student_email !== user.email) {
      return Response.json({ error: 'Enrollment not found or unauthorized' }, { status: 404 });
    }

    if (enrollment.completion_percentage < 100) {
      return Response.json({ error: 'Course not completed' }, { status: 400 });
    }

    // Generate verification code
    const verificationCode = `CS-${Date.now()}-${Math.random().toString(36).substring(7).toUpperCase()}`;

    // Create certificate PDF
    const doc = new jsPDF({
      orientation: 'landscape',
      unit: 'mm',
      format: 'a4'
    });

    // Certificate design
    const pageWidth = doc.internal.pageSize.getWidth();
    const pageHeight = doc.internal.pageSize.getHeight();

    // Border
    doc.setLineWidth(2);
    doc.setDrawColor(139, 92, 246); // Purple
    doc.rect(10, 10, pageWidth - 20, pageHeight - 20);

    // Title
    doc.setFontSize(40);
    doc.setFont('helvetica', 'bold');
    doc.text('Certificate of Completion', pageWidth / 2, 40, { align: 'center' });

    // Decorative line
    doc.setLineWidth(0.5);
    doc.line(40, 50, pageWidth - 40, 50);

    // Body text
    doc.setFontSize(14);
    doc.setFont('helvetica', 'normal');
    doc.text('This certifies that', pageWidth / 2, 70, { align: 'center' });

    // Student name
    doc.setFontSize(28);
    doc.setFont('helvetica', 'bold');
    doc.text(user.full_name, pageWidth / 2, 90, { align: 'center' });

    // Achievement text
    doc.setFontSize(14);
    doc.setFont('helvetica', 'normal');
    doc.text('has successfully completed the course', pageWidth / 2, 105, { align: 'center' });

    // Course title
    doc.setFontSize(22);
    doc.setFont('helvetica', 'bold');
    doc.text(course.title, pageWidth / 2, 125, { align: 'center' });

    // Course details
    doc.setFontSize(12);
    doc.setFont('helvetica', 'normal');
    const completionDate = new Date().toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' });
    doc.text(`Completion Date: ${completionDate}`, pageWidth / 2, 145, { align: 'center' });
    doc.text(`Duration: ${course.duration_hours} hours`, pageWidth / 2, 153, { align: 'center' });

    // Instructor signature
    doc.setFontSize(10);
    doc.text('_____________________', 60, 180);
    doc.text(course.instructor_name || 'Instructor', 60, 188);
    doc.text('Course Instructor', 60, 194);

    // Verification code
    doc.text(`Verification Code: ${verificationCode}`, pageWidth - 60, 180, { align: 'right' });
    doc.setFontSize(8);
    doc.text('Verify at coursespark.com/verify', pageWidth - 60, 188, { align: 'right' });

    // Generate PDF
    const pdfBytes = doc.output('arraybuffer');
    
    // Upload to storage
    const fileName = `certificate_${enrollment_id}_${Date.now()}.pdf`;
    const blob = new Blob([pdfBytes], { type: 'application/pdf' });
    const file = new File([blob], fileName);
    
    const { file_url } = await base44.integrations.Core.UploadFile({ file });

    // Create certificate record
    const certificate = await base44.entities.Certificate.create({
      course_id,
      course_title: course.title,
      student_email: user.email,
      student_name: user.full_name,
      completion_date: new Date().toISOString(),
      certificate_url: file_url,
      verification_code: verificationCode,
      instructor_name: course.instructor_name,
      course_duration: course.duration_hours
    });

    // Update enrollment
    await base44.entities.Enrollment.update(enrollment_id, {
      certificate_earned: true,
      certificate_id: certificate.id
    });

    // Award badge for course completion
    await base44.asServiceRole.entities.UserBadge.create({
      user_email: user.email,
      badge_id: 'course_complete',
      earned_date: new Date().toISOString(),
      badge_name: 'Course Completed',
      badge_icon: 'award'
    });

    return Response.json({ 
      success: true, 
      certificate_url: file_url,
      verification_code: verificationCode,
      certificate_id: certificate.id
    });

  } catch (error) {
    console.error('Error generating certificate:', error);
    return Response.json({ error: error.message }, { status: 500 });
  }
});