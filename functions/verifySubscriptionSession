import { createClientFromRequest } from 'npm:@base44/sdk@0.7.1';
import Stripe from 'npm:stripe@12.18.0';

Deno.serve(async (req) => {
  try {
    const base44 = createClientFromRequest(req);
    const user = await base44.auth.me();
    if (!user) {
      return Response.json({ error: 'Unauthorized' }, { status: 401 });
    }

    const { sessionId } = await req.json();
    if (!sessionId) {
      return Response.json({ error: 'Missing sessionId' }, { status: 400 });
    }

    const stripeSecret = Deno.env.get('secret_key');
    if (!stripeSecret) {
      return Response.json({ error: 'Stripe API key not configured' }, { status: 500 });
    }

    const stripe = new Stripe(stripeSecret, { apiVersion: '2024-06-20' });

    const session = await stripe.checkout.sessions.retrieve(sessionId, {
      expand: ['subscription', 'customer'],
    });

    const sessionComplete = session.status === 'complete';
    const isSubscription = session.mode === 'subscription';
    const sessionEmail = session.customer_details?.email || session.customer_email || '';
    const emailMatches = sessionEmail && user.email && sessionEmail.toLowerCase() === user.email.toLowerCase();

    const subscription = session.subscription && typeof session.subscription === 'object'
      ? session.subscription
      : null;

    const subStatus = subscription?.status || 'unknown';
    const isActive = ['active', 'trialing'].includes(subStatus);

    if (!(sessionComplete && isSubscription && emailMatches && isActive)) {
      return Response.json({
        ok: false,
        reason: 'Session not valid for activation',
        details: {
          sessionComplete,
          isSubscription,
          emailMatches,
          subStatus,
        },
      }, { status: 400 });
    }

    const now = new Date();
    const renew = new Date(subscription.current_period_end * 1000);

    await base44.asServiceRole.entities.User.update(user.id, {
      subscription: {
        plan: 'premium',
        status: 'active',
        started_at: now.toISOString(),
        renews_at: renew.toISOString(),
        stripe_customer_id: typeof session.customer === 'string' ? session.customer : session.customer?.id,
        stripe_subscription_id: subscription.id
      },
    });

    return Response.json({
      ok: true,
      subStatus,
      customerEmail: sessionEmail,
    });
  } catch (error) {
    return Response.json({ error: error.message }, { status: 500 });
  }
});